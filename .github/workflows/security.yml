name: Security Scan
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    outputs:
      all-passed: ${{ steps.check-all.outputs.all-passed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup debug environment
        run: |
          echo "=== System Information ==="
          echo "OS: $(uname -a)"
          echo "Python: $(python3 --version 2>/dev/null || echo 'not found')"
          echo "Node: $(node --version 2>/dev/null || echo 'not found')"
          echo "=== Repository Info ==="
          echo "Working dir: $(pwd)"
          find . -type f -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" | head -10 | xargs -I {} echo "Found: {}"

      - name: Semgrep scan
        id: semgrep
        continue-on-error: true
        run: |
          echo "=== Running Semgrep Scan ==="
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Semgrep ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
          if ! command -v semgrep &> /dev/null; then
            echo "Installing Semgrep..."
            python3 -m pip install semgrep || true
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Semgrep Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼
          semgrep scan \
            --config=auto \
            --verbose \
            --json \
            --output=semgrep-results.json \
            --error \
            --no-rewrite-rule-ids \
            --disable-nosem \
            --disable-version-check \
            . || true
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          if [ -f "semgrep-results.json" ]; then
            echo "=== Semgrep Results ==="
            FINDINGS_COUNT=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "Total findings: $FINDINGS_COUNT"
            
            if [ "$FINDINGS_COUNT" -gt 0 ]; then
              echo "âš ï¸ Semgrep found $FINDINGS_COUNT security issues:"
              
              # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ñ…
              jq -r '.results[] | "  - [\(.extra.severity)] \(.check_id): \(.path):\(.start.line)"' semgrep-results.json | head -20
              
              # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾Ð»Ð½Ñ‹Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ñ‹Ñ… 3 findings
              echo ""
              echo "=== Detailed findings (first 3) ==="
              jq '.results[0:3]' semgrep-results.json
              
              # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ„Ð»Ð°Ð³ Ñ‡Ñ‚Ð¾ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
              echo "semgrep_has_issues=true" >> $GITHUB_OUTPUT
              echo "semgrep_findings_count=$FINDINGS_COUNT" >> $GITHUB_OUTPUT
            else
              echo "âœ… Semgrep found no security issues"
              echo "semgrep_has_issues=false" >> $GITHUB_OUTPUT
              echo "semgrep_findings_count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Semgrep results file not generated"
            echo "semgrep_has_issues=false" >> $GITHUB_OUTPUT
            echo "semgrep_findings_count=0" >> $GITHUB_OUTPUT
          fi

      - name: npm audit (miniapp)
        id: npm-audit-miniapp
        working-directory: ./frontend-miniapp
        continue-on-error: true
        run: |
          echo "=== Running npm audit ==="
          
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found in $(pwd)"
            echo "npm_has_issues=true" >> $GITHUB_OUTPUT
            echo "npm_vulnerabilities_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ npm audit
          npm audit --audit-level=high --omit=dev --json > npm-audit-results.json 2>&1 || true
          
          if [ -f "npm-audit-results.json" ]; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
            VULN_COUNT=$(jq '[.metadata.vulnerabilities[]] | add' npm-audit-results.json 2>/dev/null || echo "0")
            HIGH_VULN=$(jq '.metadata.vulnerabilities.high' npm-audit-results.json 2>/dev/null || echo "0")
            CRITICAL_VULN=$(jq '.metadata.vulnerabilities.critical' npm-audit-results.json 2>/dev/null || echo "0")
            
            echo "Total vulnerabilities: $VULN_COUNT"
            echo "High: $HIGH_VULN, Critical: $CRITICAL_VULN"
            
            if [ "$HIGH_VULN" -gt 0 ] || [ "$CRITICAL_VULN" -gt 0 ]; then
              echo "âŒ npm audit found high/critical vulnerabilities:"
              jq '.metadata.vulnerabilities' npm-audit-results.json
              
              echo "=== Affected packages ==="
              jq -r '.vulnerabilities[] | "  - \(.name)@\(.range): \(.severity) - \(.title)"' npm-audit-results.json 2>/dev/null | head -10 || true
              
              echo "npm_has_issues=true" >> $GITHUB_OUTPUT
              echo "npm_vulnerabilities_count=$VULN_COUNT" >> $GITHUB_OUTPUT
            else
              echo "âœ… npm audit passed"
              echo "npm_has_issues=false" >> $GITHUB_OUTPUT
              echo "npm_vulnerabilities_count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… npm audit completed (no vulnerabilities found or audit passed)"
            echo "npm_has_issues=false" >> $GITHUB_OUTPUT
            echo "npm_vulnerabilities_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Bandit scan
        id: bandit
        continue-on-error: true
        run: |
          echo "=== Running Bandit Scan ==="
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ bandit ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
          if ! command -v bandit &> /dev/null; then
            echo "Installing bandit..."
            python3 -m pip install bandit || true
          fi
          
          # Ð˜Ñ‰ÐµÐ¼ Python Ñ„Ð°Ð¹Ð»Ñ‹
          PY_FILES=$(find . -type f -name "*.py" ! -path "./.*" ! -path "*/node_modules/*" ! -path "*/venv/*" | head -50)
          
          if [ -z "$PY_FILES" ]; then
            echo "â„¹ï¸ No Python files found to scan"
            echo "bandit_has_issues=false" >> $GITHUB_OUTPUT
            echo "bandit_findings_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found Python files to scan:"
          echo "$PY_FILES" | xargs -I {} echo "  - {}"
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ bandit
          echo "$PY_FILES" | xargs bandit \
            -f json \
            -o bandit-results.json \
            -ll \
            -r . \
            --exit-zero \
            --skip "B101,B404,B603,B108" 2>&1 || true
          
          if [ -f "bandit-results.json" ]; then
            FINDINGS_COUNT=$(jq '.results | length' bandit-results.json 2>/dev/null || echo "0")
            echo "Bandit findings: $FINDINGS_COUNT"
            
            if [ "$FINDINGS_COUNT" -gt 0 ]; then
              echo "âš ï¸ Bandit found $FINDINGS_COUNT security issues:"
              
              # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
              jq -r '.results[] | "  - [\(.issue_severity)] \(.test_name): \(.filename):\(.line_number) - \(.issue_text)"' bandit-results.json | head -10
              
              echo "bandit_has_issues=true" >> $GITHUB_OUTPUT
              echo "bandit_findings_count=$FINDINGS_COUNT" >> $GITHUB_OUTPUT
            else
              echo "âœ… Bandit found no security issues"
              echo "bandit_has_issues=false" >> $GITHUB_OUTPUT
              echo "bandit_findings_count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… Bandit scan completed"
            echo "bandit_has_issues=false" >> $GITHUB_OUTPUT
            echo "bandit_findings_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Summary and decision
        id: check-all
        run: |
          echo "=== Security Scan Summary ==="
          echo ""
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          SEMGREP_ISSUES=${{ steps.semgrep.outputs.semgrep_has_issues || 'false' }}
          SEMGREP_COUNT=${{ steps.semgrep.outputs.semgrep_findings_count || '0' }}
          
          NPM_ISSUES=${{ steps.npm-audit-miniapp.outputs.npm_has_issues || 'false' }}
          NPM_COUNT=${{ steps.npm-audit-miniapp.outputs.npm_vulnerabilities_count || '0' }}
          
          BANDIT_ISSUES=${{ steps.bandit.outputs.bandit_has_issues || 'false' }}
          BANDIT_COUNT=${{ steps.bandit.outputs.bandit_findings_count || '0' }}
          
          echo "ðŸ“Š Results Summary:"
          echo "  Semgrep:   $SEMGREP_COUNT findings ($([ "$SEMGREP_ISSUES" = "true" ] && echo "âŒ FAILED" || echo "âœ… PASSED"))"
          echo "  npm audit: $NPM_COUNT vulnerabilities ($([ "$NPM_ISSUES" = "true" ] && echo "âŒ FAILED" || echo "âœ… PASSED"))"
          echo "  Bandit:    $BANDIT_COUNT findings ($([ "$BANDIT_ISSUES" = "true" ] && echo "âŒ FAILED" || echo "âœ… PASSED"))"
          echo ""
          
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¾Ð±Ñ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
          # ÐœÐ¾Ð¶Ð½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÑƒ: ÐºÐ°ÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¼Ð¸
          FAILED=false
          FAILED_TOOLS=""
          
          # ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: Semgrep - warning Ñ‚Ð¾Ð»ÑŒÐºÐ¾
          if [ "$SEMGREP_ISSUES" = "true" ]; then
            echo "âš ï¸  Semgrep found issues (set as warning)"
            # Semgrep Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ warning, Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¼
            # FAILED=true
            # FAILED_TOOLS="$FAILED_TOOLS Semgrep"
          fi
          
          # ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: npm audit - Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð½Ð° high/critical
          if [ "$NPM_ISSUES" = "true" ]; then
            echo "âŒ npm audit found HIGH/CRITICAL vulnerabilities"
            FAILED=true
            FAILED_TOOLS="$FAILED_TOOLS npm-audit"
          fi
          
          # ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°: Bandit - Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð½Ð° high
          if [ "$BANDIT_ISSUES" = "true" ]; then
            echo "âŒ Bandit found security issues"
            FAILED=true
            FAILED_TOOLS="$FAILED_TOOLS Bandit"
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo "::error::Security scan failed: $FAILED_TOOLS"
            echo "all-passed=false" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ”§ Next steps:"
            echo "1. Review the findings above"
            echo "2. Check the generated JSON files for details"
            echo "3. Fix critical issues before merging"
            echo "4. For false positives, add exceptions to the scan configuration"
            exit 1
          else
            echo "âœ… All security checks passed!"
            echo "all-passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload scan results as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            semgrep-results.json
            bandit-results.json
            frontend-miniapp/npm-audit-results.json
          retention-days: 30
