name: Security Scan
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    outputs:
      all-passed: ${{ steps.decision.outputs.all-passed }}
      semgrep-findings: ${{ steps.semgrep.outputs.total_findings }}
      npm-vulnerabilities: ${{ steps.npm-audit.outputs.vulnerability_count }}
      bandit-findings: ${{ steps.bandit.outputs.total_findings }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Semgrep scan (full rules)
        id: semgrep
        continue-on-error: true
        run: |
          pip install semgrep --quiet
          
          echo "ğŸš€ Starting Semgrep with comprehensive rules..."
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Semgrep Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ exit code
          set +e
          semgrep scan \
            --config="p/security-audit" \
            --config="p/secrets" \
            --config="p/ci" \
            --json \
            --output=semgrep-results.json \
            --metrics=auto \
            --disable-version-check \
            --no-rewrite-rule-ids \
            .
          SEMGREP_EXIT_CODE=$?
          set -e
          
          echo "Semgrep exit code: $SEMGREP_EXIT_CODE"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½
          if [ ! -f "semgrep-results.json" ]; then
            echo "âš ï¸ Semgrep results file not created!"
            echo "scan_completed=false" >> $GITHUB_OUTPUT
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "error_findings=0" >> $GITHUB_OUTPUT
            echo "warning_findings=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "scan_completed=true" >> $GITHUB_OUTPUT
          
          # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
          TOTAL=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
          ERROR=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json 2>/dev/null || echo "0")
          WARNING=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json 2>/dev/null || echo "0")
          
          echo "total_findings=$TOTAL" >> $GITHUB_OUTPUT
          echo "error_findings=$ERROR" >> $GITHUB_OUTPUT
          echo "warning_findings=$WARNING" >> $GITHUB_OUTPUT
          
          echo ""
          echo "========================================="
          echo "ğŸ” SEMGREP RESULTS"
          echo "========================================="
          echo "ğŸ“Š Total findings: $TOTAL (ERROR: $ERROR, WARNING: $WARNING)"
          echo ""
          
          if [ "$TOTAL" -gt 0 ]; then
            echo "ğŸ“‹ Found issues:"
            echo ""
            jq -r '.results[] | "\(.extra.severity) | \(.check_id) | \(.path):\(.start.line) | \(.extra.message)"' semgrep-results.json | head -20
            
            echo ""
            echo "ğŸ“ˆ By rule type:"
            jq -r '.results[] | .check_id' semgrep-results.json | cut -d'.' -f1-3 | sort | uniq -c | sort -rn
          else
            echo "âœ… No issues found with current rule set"
            echo "â„¹ï¸ Using config: p/security-audit + p/secrets + p/ci"
          fi

      - name: npm audit
        id: npm-audit
        continue-on-error: true
        run: |
          echo "ğŸ“¦ Starting npm audit..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ package.json
          if [ ! -f "package.json" ]; then
            echo "â„¹ï¸ No package.json found, skipping npm audit"
            echo "scan_completed=false" >> $GITHUB_OUTPUT
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "moderate_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "low_vulnerabilities=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "scan_completed=true" >> $GITHUB_OUTPUT
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ lock Ñ„Ğ°Ğ¹Ğ»
          if [ -f "package-lock.json" ]; then
            npm ci --audit=false --quiet || npm install --audit=false --quiet
          else
            npm install --audit=false --quiet
          fi
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ audit
          set +e
          npm audit --json > npm-audit-results.json 2>&1
          NPM_EXIT_CODE=$?
          set -e
          
          echo "npm audit exit code: $NPM_EXIT_CODE"
          
          # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
          if [ -f "npm-audit-results.json" ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json 2>/dev/null || echo "0")
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit-results.json 2>/dev/null || echo "0")
            LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit-results.json 2>/dev/null || echo "0")
            TOTAL=$(jq '.metadata.vulnerabilities.total // 0' npm-audit-results.json 2>/dev/null || echo "0")
            
            echo "vulnerability_count=$TOTAL" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=$HIGH" >> $GITHUB_OUTPUT
            echo "moderate_vulnerabilities=$MODERATE" >> $GITHUB_OUTPUT
            echo "low_vulnerabilities=$LOW" >> $GITHUB_OUTPUT
            
            echo ""
            echo "========================================="
            echo "ğŸ“¦ NPM AUDIT RESULTS"
            echo "========================================="
            echo "ğŸ“Š Total vulnerabilities: $TOTAL"
            echo "   CRITICAL: $CRITICAL"
            echo "   HIGH: $HIGH"
            echo "   MODERATE: $MODERATE"
            echo "   LOW: $LOW"
            echo ""
            
            if [ "$TOTAL" -gt 0 ]; then
              echo "âš ï¸ Vulnerable packages:"
              jq -r '.vulnerabilities | to_entries | .[] | "\(.value.severity) | \(.key) | \(.value.via[0].title // "N/A")"' npm-audit-results.json 2>/dev/null | head -15 || echo "Unable to parse details"
            else
              echo "âœ… No vulnerabilities found!"
            fi
          else
            echo "âš ï¸ npm audit results file not created"
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "moderate_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "low_vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: Bandit scan (with details)
        id: bandit
        continue-on-error: true
        run: |
          pip install bandit --quiet
          
          echo "ğŸ Starting Bandit Python security scan..."
          
          # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Python Ñ„Ğ°Ğ¹Ğ»Ñ‹
          PY_FILES=$(find . -type f -name "*.py" ! -path "./.*" ! -path "*/node_modules/*" ! -path "*/venv/*" ! -path "*/__pycache__/*" 2>/dev/null || echo "")
          COUNT=$(echo "$PY_FILES" | grep -c . || echo "0")
          
          echo "Found $COUNT Python files"
          
          if [ "$COUNT" -eq 0 ] || [ -z "$PY_FILES" ]; then
            echo "â„¹ï¸ No Python files to scan"
            echo "scan_completed=false" >> $GITHUB_OUTPUT
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "high_findings=0" >> $GITHUB_OUTPUT
            echo "medium_findings=0" >> $GITHUB_OUTPUT
            echo "low_findings=0" >> $GITHUB_OUTPUT
            echo "dangerous_findings=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "scan_completed=true" >> $GITHUB_OUTPUT
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ bandit
          set +e
          echo "$PY_FILES" | xargs bandit \
            -f json \
            -o bandit-results.json \
            -ll \
            --exit-zero
          BANDIT_EXIT_CODE=$?
          set -e
          
          echo "Bandit exit code: $BANDIT_EXIT_CODE"
          
          if [ ! -f "bandit-results.json" ]; then
            echo "âš ï¸ Bandit results file not created"
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "high_findings=0" >> $GITHUB_OUTPUT
            echo "medium_findings=0" >> $GITHUB_OUTPUT
            echo "low_findings=0" >> $GITHUB_OUTPUT
            echo "dangerous_findings=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
          TOTAL=$(jq '.results | length' bandit-results.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-results.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-results.json 2>/dev/null || echo "0")
          LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-results.json 2>/dev/null || echo "0")
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹ issues
          DANGEROUS=$(jq '[.results[] | select(.test_id == "B104" or .test_id == "B608" or .test_id == "hardcoded_bind_all_interfaces" or .test_id == "hardcoded_sql_expressions")] | length' bandit-results.json 2>/dev/null || echo "0")
          
          echo "total_findings=$TOTAL" >> $GITHUB_OUTPUT
          echo "high_findings=$HIGH" >> $GITHUB_OUTPUT
          echo "medium_findings=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low_findings=$LOW" >> $GITHUB_OUTPUT
          echo "dangerous_findings=$DANGEROUS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "========================================="
          echo "ğŸ BANDIT RESULTS"
          echo "========================================="
          echo "ğŸ“Š Total findings: $TOTAL (HIGH: $HIGH, MEDIUM: $MEDIUM, LOW: $LOW)"
          echo "âš ï¸ Dangerous findings: $DANGEROUS (bind all interfaces / SQL injection risks)"
          echo ""
          
          if [ "$TOTAL" -gt 0 ]; then
            echo "ğŸ“ˆ By issue type:"
            jq -r '.results[] | "\(.test_id) - \(.test_name)"' bandit-results.json | sort | uniq -c | sort -rn
            
            echo ""
            echo "ğŸ“‹ Top issues (showing first 10):"
            echo ""
            jq -r '.results[] | "\(.issue_severity) | \(.test_name) | \(.filename):\(.line_number)\n  â””â”€ \(.issue_text)\n"' bandit-results.json | head -40
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹
            if [ "$DANGEROUS" -gt 0 ]; then
              echo ""
              echo "ğŸš¨ CRITICAL SECURITY ISSUES DETECTED:"
              echo ""
              
              # B104: hardcoded_bind_all_interfaces
              BIND_ALL=$(jq '[.results[] | select(.test_id == "B104")] | length' bandit-results.json 2>/dev/null || echo "0")
              if [ "$BIND_ALL" -gt 0 ]; then
                echo "âŒ BIND ALL INTERFACES (0.0.0.0) - Found $BIND_ALL instances:"
                echo "   Risk: Server accessible from all network interfaces"
                echo "   Fix: Use 127.0.0.1 for local or specific IP for production"
                jq -r '.results[] | select(.test_id == "B104") | "   ğŸ“ \(.filename):\(.line_number)"' bandit-results.json
                echo ""
              fi
              
              # B608: hardcoded SQL
              SQL_HARD=$(jq '[.results[] | select(.test_id == "B608")] | length' bandit-results.json 2>/dev/null || echo "0")
              if [ "$SQL_HARD" -gt 0 ]; then
                echo "âŒ HARDCODED SQL EXPRESSIONS - Found $SQL_HARD instances:"
                echo "   Risk: Potential SQL injection vulnerability"
                echo "   Fix: Use parameterized queries or ORM"
                jq -r '.results[] | select(.test_id == "B608") | "   ğŸ“ \(.filename):\(.line_number)"' bandit-results.json
                echo ""
              fi
            fi
          else
            echo "âœ… No Python security issues found!"
          fi

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-reports
          path: |
            semgrep-results.json
            npm-audit-results.json
            bandit-results.json
          if-no-files-found: ignore
          retention-days: 30

      - name: Decision gate
        id: decision
        if: always()
        run: |
          echo "========================================="
          echo "ğŸš¦ SECURITY DECISION GATE"
          echo "========================================="
          echo ""
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑĞºĞ°Ğ½Ñ‹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ¸ÑÑŒ
          SEMGREP_COMPLETED="${{ steps.semgrep.outputs.scan_completed || 'false' }}"
          NPM_COMPLETED="${{ steps.npm-audit.outputs.scan_completed || 'false' }}"
          BANDIT_COMPLETED="${{ steps.bandit.outputs.scan_completed || 'false' }}"
          
          echo "ğŸ“‹ Scan Status:"
          echo "  Semgrep:   $SEMGREP_COMPLETED"
          echo "  npm audit: $NPM_COMPLETED"
          echo "  Bandit:    $BANDIT_COMPLETED"
          echo ""
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ (Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾, Ñ fallback)
          SEMGREP_TOTAL="${{ steps.semgrep.outputs.total_findings || '0' }}"
          SEMGREP_ERROR="${{ steps.semgrep.outputs.error_findings || '0' }}"
          
          NPM_CRITICAL="${{ steps.npm-audit.outputs.critical_vulnerabilities || '0' }}"
          NPM_HIGH="${{ steps.npm-audit.outputs.high_vulnerabilities || '0' }}"
          NPM_TOTAL="${{ steps.npm-audit.outputs.vulnerability_count || '0' }}"
          
          BANDIT_TOTAL="${{ steps.bandit.outputs.total_findings || '0' }}"
          BANDIT_HIGH="${{ steps.bandit.outputs.high_findings || '0' }}"
          BANDIT_MEDIUM="${{ steps.bandit.outputs.medium_findings || '0' }}"
          BANDIT_DANGEROUS="${{ steps.bandit.outputs.dangerous_findings || '0' }}"
          
          echo "ğŸ“Š Findings Summary:"
          echo "  Semgrep:   $SEMGREP_TOTAL total ($SEMGREP_ERROR ERROR severity)"
          echo "  npm:       $NPM_TOTAL total ($NPM_CRITICAL CRITICAL, $NPM_HIGH HIGH)"
          echo "  Bandit:    $BANDIT_TOTAL total ($BANDIT_HIGH HIGH, $BANDIT_MEDIUM MEDIUM)"
          echo "  Dangerous: $BANDIT_DANGEROUS critical patterns (SQL/bind risks)"
          echo ""
          
          # ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
          FAIL=false
          REASONS=""
          
          # 1. npm CRITICAL Ğ²ÑĞµĞ³Ğ´Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚
          if [ "$NPM_CRITICAL" -gt 0 ]; then
            FAIL=true
            REASONS="${REASONS}âŒ $NPM_CRITICAL CRITICAL npm vulnerabilities must be fixed; "
          fi
          
          # 2. npm HIGH > 5 Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚
          if [ "$NPM_HIGH" -gt 5 ]; then
            FAIL=true
            REASONS="${REASONS}âŒ $NPM_HIGH HIGH npm vulnerabilities (threshold: 5); "
          fi
          
          # 3. Bandit Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‚
          if [ "$BANDIT_DANGEROUS" -gt 0 ]; then
            FAIL=true
            REASONS="${REASONS}âŒ $BANDIT_DANGEROUS dangerous Bandit patterns (SQL injection/bind all interfaces); "
          fi
          
          # 4. Bandit HIGH > 3 Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚
          if [ "$BANDIT_HIGH" -gt 3 ]; then
            FAIL=true
            REASONS="${REASONS}âŒ $BANDIT_HIGH HIGH severity Bandit findings (threshold: 3); "
          fi
          
          # 5. Semgrep ERROR > 10 Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚
          if [ "$SEMGREP_ERROR" -gt 10 ]; then
            FAIL=true
            REASONS="${REASONS}âŒ $SEMGREP_ERROR Semgrep ERROR findings (threshold: 10); "
          fi
          
          # 6. ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ (Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‚, Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ)
          WARNINGS=""
          if [ "$SEMGREP_ERROR" -gt 0 ] && [ "$SEMGREP_ERROR" -le 10 ]; then
            WARNINGS="${WARNINGS}âš ï¸  $SEMGREP_ERROR Semgrep ERROR findings (review recommended); "
          fi
          
          if [ "$BANDIT_MEDIUM" -gt 5 ]; then
            WARNINGS="${WARNINGS}âš ï¸  $BANDIT_MEDIUM Bandit MEDIUM findings (review recommended); "
          fi
          
          if [ "$NPM_HIGH" -gt 0 ] && [ "$NPM_HIGH" -le 5 ]; then
            WARNINGS="${WARNINGS}âš ï¸  $NPM_HIGH HIGH npm vulnerabilities (review recommended); "
          fi
          
          # Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ
          echo "========================================="
          if [ "$FAIL" = true ]; then
            echo "âŒ SECURITY GATE: BLOCKED"
            echo "========================================="
            echo ""
            echo "Blocking reasons:"
            echo "$REASONS" | tr ';' '\n'
            echo ""
            echo "ğŸ”§ Required actions:"
            echo "1. Review detailed scan results above"
            echo "2. Download artifacts for full reports"
            echo "3. Fix blocking security issues:"
            [ "$NPM_CRITICAL" -gt 0 ] && echo "   - Update npm packages with CRITICAL vulnerabilities"
            [ "$BANDIT_DANGEROUS" -gt 0 ] && echo "   - Fix dangerous Python patterns (SQL injection / bind 0.0.0.0)"
            [ "$BANDIT_HIGH" -gt 3 ] && echo "   - Address HIGH severity Bandit findings"
            echo ""
            
            echo "all-passed=false" >> $GITHUB_OUTPUT
            echo "::error::Security gate blocked: $REASONS"
            exit 1
          else
            echo "âœ… SECURITY GATE: PASSED"
            echo "========================================="
            echo ""
            
            if [ -n "$WARNINGS" ]; then
              echo "âš ï¸ Warnings (non-blocking):"
              echo "$WARNINGS" | tr ';' '\n'
              echo ""
              echo "Consider addressing these issues in future commits."
            else
              echo "ğŸ‰ No security issues found!"
            fi
            
            echo "all-passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const semgrepTotal = '${{ steps.semgrep.outputs.total_findings || '0' }}';
            const npmTotal = '${{ steps.npm-audit.outputs.vulnerability_count || '0' }}';
            const banditTotal = '${{ steps.bandit.outputs.total_findings || '0' }}';
            const allPassed = '${{ steps.decision.outputs.all-passed }}' === 'true';
            
            const status = allPassed ? 'âœ… Passed' : 'âŒ Blocked';
            const emoji = allPassed ? 'ğŸ‰' : 'ğŸš¨';
            
            const body = `## ${emoji} Security Scan Results
            
            **Status:** ${status}
            
            | Scanner | Findings |
            |---------|----------|
            | Semgrep | ${semgrepTotal} |
            | npm audit | ${npmTotal} |
            | Bandit | ${banditTotal} |
            
            ${allPassed ? '' : 'âš ï¸ **Security gate blocked this PR.** Check the workflow logs for details.'}
            
            ğŸ“¥ Download detailed reports from workflow artifacts.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

