name: Security Scan
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    outputs:
      all-passed: ${{ steps.decision.outputs.all-passed }}
      semgrep-findings: ${{ steps.semgrep.outputs.total_findings }}
      npm-vulnerabilities: ${{ steps.npm-audit.outputs.vulnerability_count }}
      bandit-findings: ${{ steps.bandit.outputs.total_findings }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Semgrep scan
        id: semgrep
        continue-on-error: true
        run: |
          pip install semgrep --quiet
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ semgrep Ñ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ°Ð¼Ð¸ Ð¸Ð»Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð¼
          semgrep scan \
            --config="p/security-audit" \
            --json \
            --output=semgrep-results.json \
            --metrics=auto \
            --disable-version-check \
            . || true
          
          # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          if [ -f "semgrep-results.json" ]; then
            TOTAL=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            ERROR=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json 2>/dev/null || echo "0")
            WARNING=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json 2>/dev/null || echo "0")
            
            echo "total_findings=$TOTAL" >> $GITHUB_OUTPUT
            echo "error_findings=$ERROR" >> $GITHUB_OUTPUT
            echo "warning_findings=$WARNING" >> $GITHUB_OUTPUT
            
            echo "=== Semgrep Results Summary ==="
            echo "Total findings: $TOTAL"
            echo "ERROR severity: $ERROR"
            echo "WARNING severity: $WARNING"
            
            if [ "$TOTAL" -gt 0 ]; then
              echo ""
              echo "=== Top findings ==="
              jq -r '.results[0:10][] | "\(.extra.severity) - \(.check_id): \(.path):\(.start.line)"' semgrep-results.json
            fi
          else
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "error_findings=0" >> $GITHUB_OUTPUT
            echo "warning_findings=0" >> $GITHUB_OUTPUT
          fi

      - name: npm audit (miniapp)
        id: npm-audit
        working-directory: ./frontend-miniapp
        continue-on-error: true
        run: |
          if [ ! -f "package.json" ]; then
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "âœ… No package.json found"
            exit 0
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ npm audit
          npm audit --audit-level=high --omit=dev --json > npm-audit-results.json 2>&1 || true
          
          if [ -f "npm-audit-results.json" ]; then
            TOTAL=$(jq '[.metadata.vulnerabilities[]] | add' npm-audit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high' npm-audit-results.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '.metadata.vulnerabilities.critical' npm-audit-results.json 2>/dev/null || echo "0")
            
            echo "vulnerability_count=$TOTAL" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=$HIGH" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=$CRITICAL" >> $GITHUB_OUTPUT
            
            echo "=== npm audit Results ==="
            echo "Total vulnerabilities: $TOTAL"
            echo "High: $HIGH, Critical: $CRITICAL"
            
            # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð´ÐµÑ‚Ð°Ð»Ð¸ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸
            if [ "$TOTAL" -gt 0 ]; then
              echo ""
              echo "=== Affected packages ==="
              jq -r '.vulnerabilities[]? | "  - \(.name)@\(.range): \(.severity) - \(.title)"' npm-audit-results.json 2>/dev/null | head -5
            fi
          else
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: Bandit scan
        id: bandit
        continue-on-error: true
        run: |
          pip install bandit --quiet
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Python Ñ„Ð°Ð¹Ð»Ñ‹
          PY_FILES=$(find . -type f -name "*.py" ! -path "./.*" ! -path "*/node_modules/*" ! -path "*/venv/*" 2>/dev/null | head -50)
          
          if [ -z "$PY_FILES" ]; then
            echo "â„¹ï¸ No Python files found to scan"
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "high_findings=0" >> $GITHUB_OUTPUT
            echo "medium_findings=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found $(echo "$PY_FILES" | wc -l) Python files to scan"
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ bandit
          echo "$PY_FILES" | xargs bandit \
            -f json \
            -o bandit-results.json \
            -ll \
            --exit-zero \
            2>/dev/null || true
          
          if [ -f "bandit-results.json" ]; then
            TOTAL=$(jq '.results | length' bandit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-results.json 2>/dev/null || echo "0")
            
            echo "total_findings=$TOTAL" >> $GITHUB_OUTPUT
            echo "high_findings=$HIGH" >> $GITHUB_OUTPUT
            echo "medium_findings=$MEDIUM" >> $GITHUB_OUTPUT
            
            echo "=== Bandit Results ==="
            echo "Total findings: $TOTAL"
            echo "High: $HIGH, Medium: $MEDIUM"
            
            # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð´ÐµÑ‚Ð°Ð»Ð¸ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
            if [ "$TOTAL" -gt 0 ]; then
              echo ""
              echo "=== Top findings ==="
              jq -r '.results[0:5][] | "\(.issue_severity) - \(.test_name): \(.filename):\(.line_number)"' bandit-results.json
            fi
          else
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "high_findings=0" >> $GITHUB_OUTPUT
            echo "medium_findings=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate security report
        id: report
        if: always()
        run: |
          echo "# ðŸ“Š Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Scan date:** $(date)" >> security-report.md
          echo "" >> security-report.md
          
          # Semgrep
          SEMGREP_TOTAL=${{ steps.semgrep.outputs.total_findings || '0' }}
          SEMGREP_ERROR=${{ steps.semgrep.outputs.error_findings || '0' }}
          SEMGREP_WARNING=${{ steps.semgrep.outputs.warning_findings || '0' }}
          
          echo "## ðŸ” Semgrep (Code Security)" >> security-report.md
          echo "- **Total findings:** $SEMGREP_TOTAL" >> security-report.md
          echo "- **Critical (ERROR):** $SEMGREP_ERROR" >> security-report.md
          echo "- **Warnings:** $SEMGREP_WARNING" >> security-report.md
          
          if [ "$SEMGREP_TOTAL" -gt 0 ]; then
            echo "" >> security-report.md
            echo "### Top issues:" >> security-report.md
            if [ -f "semgrep-results.json" ]; then
              jq -r '.results[0:5][] | "- **\(.extra.severity)** `\(.check_id)` in `\(.path):\(.start.line)` - \(.extra.message)"' semgrep-results.json >> security-report.md 2>/dev/null || true
            fi
          fi
          echo "" >> security-report.md
          
          # npm audit
          NPM_TOTAL=${{ steps.npm-audit.outputs.vulnerability_count || '0' }}
          NPM_CRITICAL=${{ steps.npm-audit.outputs.critical_vulnerabilities || '0' }}
          NPM_HIGH=${{ steps.npm-audit.outputs.high_vulnerabilities || '0' }}
          
          echo "## ðŸ“¦ npm audit (Dependencies)" >> security-report.md
          echo "- **Total vulnerabilities:** $NPM_TOTAL" >> security-report.md
          echo "- **Critical:** $NPM_CRITICAL" >> security-report.md
          echo "- **High:** $NPM_HIGH" >> security-report.md
          echo "" >> security-report.md
          
          # Bandit
          BANDIT_TOTAL=${{ steps.bandit.outputs.total_findings || '0' }}
          BANDIT_HIGH=${{ steps.bandit.outputs.high_findings || '0' }}
          BANDIT_MEDIUM=${{ steps.bandit.outputs.medium_findings || '0' }}
          
          echo "## ðŸ Bandit (Python Security)" >> security-report.md
          echo "- **Total findings:** $BANDIT_TOTAL" >> security-report.md
          echo "- **High severity:** $BANDIT_HIGH" >> security-report.md
          echo "- **Medium severity:** $BANDIT_MEDIUM" >> security-report.md
          
          if [ "$BANDIT_TOTAL" -gt 0 ]; then
            echo "" >> security-report.md
            echo "### Top issues:" >> security-report.md
            if [ -f "bandit-results.json" ]; then
              jq -r '.results[0:5][] | "- **\(.issue_severity)** `\(.test_name)` in `\(.filename):\(.line_number)` - \(.issue_text)"' bandit-results.json >> security-report.md 2>/dev/null || true
            fi
          fi
          echo "" >> security-report.md
          
          # Summary
          echo "## ðŸ“ˆ Summary" >> security-report.md
          echo "Security scan completed. Review findings above and address critical issues." >> security-report.md
          echo "" >> security-report.md
          echo "> **Note:** This report is generated automatically. Some findings may be false positives." >> security-report.md

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security-report.md
            semgrep-results.json
            bandit-results.json
            frontend-miniapp/npm-audit-results.json
          retention-days: 30

      - name: Decision gate
        id: decision
        run: |
          echo "=== Security Decision Gate ==="
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
          SEMGREP_ERROR=${{ steps.semgrep.outputs.error_findings || '0' }}
          NPM_CRITICAL=${{ steps.npm-audit.outputs.critical_vulnerabilities || '0' }}
          NPM_HIGH=${{ steps.npm-audit.outputs.high_vulnerabilities || '0' }}
          BANDIT_HIGH=${{ steps.bandit.outputs.high_findings || '0' }}
          
          echo "Metrics:"
          echo "- Semgrep ERROR findings: $SEMGREP_ERROR"
          echo "- npm CRITICAL vulnerabilities: $NPM_CRITICAL"
          echo "- npm HIGH vulnerabilities: $NPM_HIGH"
          echo "- Bandit HIGH findings: $BANDIT_HIGH"
          echo ""
          
          # ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ (Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼Ð°Ñ)
          FAIL=false
          REASONS=""
          
          # ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 1: ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ npm Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÑŽÑ‚ Ð¼ÐµÑ€Ð¶
          if [ "$NPM_CRITICAL" -gt 0 ]; then
            FAIL=true
            REASONS="$REASONSâŒ Found $NPM_CRITICAL CRITICAL npm vulnerabilities (must be 0); "
          fi
          
          # ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 2: High ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ npm (Ð´Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´Ð¾ 3)
          if [ "$NPM_HIGH" -gt 3 ]; then
            FAIL=true
            REASONS="$REASONSâŒ Found $NPM_HIGH HIGH npm vulnerabilities (max 3 allowed); "
          elif [ "$NPM_HIGH" -gt 0 ]; then
            echo "âš ï¸  Found $NPM_HIGH HIGH npm vulnerabilities (review recommended)"
          fi
          
          # ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 3: High Bandit findings Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÑŽÑ‚
          if [ "$BANDIT_HIGH" -gt 0 ]; then
            FAIL=true
            REASONS="$REASONSâŒ Found $BANDIT_HIGH HIGH Bandit security issues; "
          fi
          
          # ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 4: Semgrep ERROR (Ð´Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´Ð¾ 5, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ false positives)
          if [ "$SEMGREP_ERROR" -gt 5 ]; then
            FAIL=true
            REASONS="$REASONSâŒ Found $SEMGREP_ERROR Semgrep ERROR findings (max 5 allowed); "
          elif [ "$SEMGREP_ERROR" -gt 0 ]; then
            echo "âš ï¸  Found $SEMGREP_ERROR Semgrep ERROR findings (review recommended)"
          fi
          
          if [ "$FAIL" = true ]; then
            echo "all-passed=false" >> $GITHUB_OUTPUT
            echo "::error::Security gate blocked: $REASONS"
            echo "âŒ Security checks failed: $REASONS"
            echo ""
            echo "## Next steps:"
            echo "1. Review the security report artifact"
            echo "2. Fix critical and high severity issues"
            echo "3. For false positives, add exceptions to .semgrepignore or adjust rules"
            exit 1
          else
            echo "all-passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Security checks passed"
            echo ""
            echo "## Status:"
            if [ "$SEMGREP_ERROR" -gt 0 ] || [ "$NPM_HIGH" -gt 0 ] || [ "$BANDIT_HIGH" -gt 0 ]; then
              echo "âš ï¸  Some security issues found (within allowed limits). Review recommended."
            else
              echo "ðŸŽ‰ No critical security issues found!"
            fi
          fi

      - name: Create GitHub annotations for PR
        if: failure() && github.event_name == 'pull_request'
        run: |
          # ÐÐ½Ð½Ð¾Ñ‚Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Semgrep
          if [ -f "semgrep-results.json" ]; then
            echo "Creating Semgrep annotations..."
            jq -r '.results[] | select(.extra.severity == "ERROR") | "::error file=\(.path),line=\(.start.line),col=\(.start.col)::[Semgrep ERROR] \(.extra.message) (Rule: \(.check_id))"' semgrep-results.json 2>/dev/null || true
          fi
          
          # ÐÐ½Ð½Ð¾Ñ‚Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Bandit
          if [ -f "bandit-results.json" ]; then
            echo "Creating Bandit annotations..."
            jq -r '.results[] | select(.issue_severity == "HIGH") | "::error file=\(.filename),line=\(.line_number),col=1::[Bandit HIGH] \(.issue_text) (Test: \(.test_name))"' bandit-results.json 2>/dev/null || true
          fi
