name: Security Scan
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    outputs:
      all-passed: ${{ steps.check-all.outputs.all-passed }}
    steps:
      - uses: actions/checkout@v4

      - name: Semgrep scan
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: auto

      - name: npm audit (miniapp)
        id: npm-audit-miniapp
        working-directory: ./frontend-miniapp
        continue-on-error: true
        run: |
          npm audit --audit-level=high --omit=dev
          echo "npm_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Bandit
        id: bandit
        uses: PyCQA/bandit-action@v1
        continue-on-error: true
        with:
          # Убедитесь, что bandit-action устанавливает exit-code в outputs
          # или используем альтернативный подход
          args: --exit-zero

      - name: Check all scans passed
        id: check-all
        run: |
          # Способ 1: Используем outcome (рекомендуется для continue-on-error)
          SEMGREP_PASSED=${{ steps.semgrep.outcome == 'success' }}
          NPM_AUDIT_PASSED=${{ steps.npm-audit-miniapp.outcome == 'success' }}
          BANDIT_PASSED=${{ steps.bandit.outcome == 'success' }}
          
          echo "SEMGREP_PASSED: $SEMGREP_PASSED"
          echo "NPM_AUDIT_PASSED: $NPM_AUDIT_PASSED"
          echo "BANDIT_PASSED: $BANDIT_PASSED"
          
          if [ "$SEMGREP_PASSED" = "true" ] && \
             [ "$NPM_AUDIT_PASSED" = "true" ] && \
             [ "$BANDIT_PASSED" = "true" ]; then
            echo "all-passed=true" >> $GITHUB_OUTPUT
            echo "✅ All security scans passed"
          else
            echo "all-passed=false" >> $GITHUB_OUTPUT
            echo "❌ Some scans failed:"
            echo "- Semgrep: $SEMGREP_PASSED"
            echo "- npm audit (miniapp): $NPM_AUDIT_PASSED"
            echo "- Bandit: $BANDIT_PASSED"
            exit 1
          fi
