name: Security Scan
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    outputs:
      all-passed: ${{ steps.check-all.outputs.all-passed }}
    steps:
      - uses: actions/checkout@v4

      - name: Semgrep scan
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: auto

      - name: npm audit (miniapp)
        id: npm-audit-miniapp
        working-directory: ./frontend-miniapp
        continue-on-error: true
        run: npm audit --audit-level=high --omit=dev

      - name: Bandit
        id: bandit
        uses: PyCQA/bandit-action@v1
        continue-on-error: true

      - name: Check all scans passed
        id: check-all
        run: |
          # Получаем коды завершения
          SEMGREP_EXIT_CODE=${{ steps.semgrep.outputs.exit-code }}
          # Для npm audit используем outcome, так как continue-on-error: true
          # Если успешно - 0, если ошибка - 1
          NPM_MINIAPP_EXIT_CODE=${{ steps.npm-audit-miniapp.outcome == 'success' && '0' || '1' }}
          BANDIT_EXIT_CODE=${{ steps.bandit.outputs.exit-code }}
          
          echo "SEMGREP_EXIT_CODE: $SEMGREP_EXIT_CODE"
          echo "NPM_MINIAPP_EXIT_CODE: $NPM_MINIAPP_EXIT_CODE"
          echo "BANDIT_EXIT_CODE: $BANDIT_EXIT_CODE"
          
          # Проверяем все коды завершения
          if [ "$SEMGREP_EXIT_CODE" = "0" ] && \
             [ "$NPM_MINIAPP_EXIT_CODE" = "0" ] && \
             [ "$BANDIT_EXIT_CODE" = "0" ]; then
            echo "all-passed=true" >> $GITHUB_OUTPUT
            echo "✅ All security scans passed"
          else
            echo "all-passed=false" >> $GITHUB_OUTPUT
            echo "❌ Some scans failed:"
            echo "- Semgrep: $SEMGREP_EXIT_CODE"
            echo "- npm audit (miniapp): $NPM_MINIAPP_EXIT_CODE"
            echo "- Bandit: $BANDIT_EXIT_CODE"
            exit 1
          fi
