name: Security Scan
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    outputs:
      all-passed: ${{ steps.decision.outputs.all-passed }}
      semgrep-findings: ${{ steps.semgrep.outputs.total_findings }}
      npm-vulnerabilities: ${{ steps.npm-audit.outputs.vulnerability_count }}
      bandit-findings: ${{ steps.bandit.outputs.total_findings }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Semgrep scan
        id: semgrep
        continue-on-error: true  # –í–∞–∂–Ω–æ! –ù–µ –ø–∞–¥–∞—Ç—å –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install semgrep --quiet
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º semgrep –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          semgrep scan \
            --config=auto \
            --json \
            --output=semgrep-results.json \
            --metrics=off \
            --disable-version-check \
            . || true
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          if [ -f "semgrep-results.json" ]; then
            TOTAL=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            ERROR=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json 2>/dev/null || echo "0")
            WARNING=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json 2>/dev/null || echo "0")
            
            echo "total_findings=$TOTAL" >> $GITHUB_OUTPUT
            echo "error_findings=$ERROR" >> $GITHUB_OUTPUT
            echo "warning_findings=$WARNING" >> $GITHUB_OUTPUT
            
            # –í—ã–≤–æ–¥–∏–º —Å–≤–æ–¥–∫—É
            echo "=== Semgrep Results Summary ==="
            echo "Total findings: $TOTAL"
            echo "ERROR severity: $ERROR"
            echo "WARNING severity: $WARNING"
            
            if [ "$TOTAL" -gt 0 ]; then
              echo ""
              echo "=== Top findings ==="
              jq -r '.results[0:10][] | "\(.extra.severity) - \(.check_id): \(.path):\(.start.line)"' semgrep-results.json
            fi
          else
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "error_findings=0" >> $GITHUB_OUTPUT
            echo "warning_findings=0" >> $GITHUB_OUTPUT
          fi

      - name: npm audit (miniapp)
        id: npm-audit
        working-directory: ./frontend-miniapp
        continue-on-error: true
        run: |
          if [ ! -f "package.json" ]; then
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "‚úÖ No package.json found"
            exit 0
          fi
          
          npm audit --audit-level=high --omit=dev --json > npm-audit-results.json 2>&1 || true
          
          if [ -f "npm-audit-results.json" ]; then
            TOTAL=$(jq '[.metadata.vulnerabilities[]] | add' npm-audit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high' npm-audit-results.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '.metadata.vulnerabilities.critical' npm-audit-results.json 2>/dev/null || echo "0")
            
            echo "vulnerability_count=$TOTAL" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=$HIGH" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=$CRITICAL" >> $GITHUB_OUTPUT
            
            echo "=== npm audit Results ==="
            echo "Total vulnerabilities: $TOTAL"
            echo "High: $HIGH, Critical: $CRITICAL"
          else
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: Bandit scan
        id: bandit
        continue-on-error: true
        run: |
          pip install bandit --quiet
          
          # –ò—â–µ–º Python —Ñ–∞–π–ª—ã –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          find . -type f -name "*.py" ! -path "./.*" ! -path "*/node_modules/*" ! -path "*/venv/*" | \
            xargs bandit -f json -o bandit-results.json -ll --exit-zero 2>/dev/null || true
          
          if [ -f "bandit-results.json" ]; then
            TOTAL=$(jq '.results | length' bandit-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-results.json 2>/dev/null || echo "0")
            
            echo "total_findings=$TOTAL" >> $GITHUB_OUTPUT
            echo "high_findings=$HIGH" >> $GITHUB_OUTPUT
            echo "medium_findings=$MEDIUM" >> $GITHUB_OUTPUT
            
            echo "=== Bandit Results ==="
            echo "Total findings: $TOTAL"
            echo "High: $HIGH, Medium: $MEDIUM"
          else
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "high_findings=0" >> $GITHUB_OUTPUT
            echo "medium_findings=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate security report
        id: report
        if: always()
        run: |
          echo "# üìä Security Scan Report" > security-report.md
          echo "" >> security-report.md
          
          # Semgrep
          SEMGREP_TOTAL=${{ steps.semgrep.outputs.total_findings || '0' }}
          SEMGREP_ERROR=${{ steps.semgrep.outputs.error_findings || '0' }}
          
          echo "## üîç Semgrep" >> security-report.md
          echo "- **Total findings:** $SEMGREP_TOTAL" >> security-report.md
          echo "- **Critical (ERROR):** $SEMGREP_ERROR" >> security-report.md
          echo "" >> security-report.md
          
          # npm audit
          NPM_TOTAL=${{ steps.npm-audit.outputs.vulnerability_count || '0' }}
          NPM_CRITICAL=${{ steps.npm-audit.outputs.critical_vulnerabilities || '0' }}
          
          echo "## üì¶ npm audit (frontend-miniapp)" >> security-report.md
          echo "- **Total vulnerabilities:** $NPM_TOTAL" >> security-report.md
          echo "- **Critical:** $NPM_CRITICAL" >> security-report.md
          echo "" >> security-report.md
          
          # Bandit
          BANDIT_TOTAL=${{ steps.bandit.outputs.total_findings || '0' }}
          BANDIT_HIGH=${{ steps.bandit.outputs.high_findings || '0' }}
          
          echo "## üêç Bandit (Python)" >> security-report.md
          echo "- **Total findings:** $BANDIT_TOTAL" >> security-report.md
          echo "- **High severity:** $BANDIT_HIGH" >> security-report.md
          echo "" >> security-report.md
          
          echo "## üìà Summary" >> security-report.md
          echo "Scan completed successfully. Review findings above." >> security-report.md

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md

      - name: Decision gate
        id: decision
        run: |
          echo "=== Security Decision Gate ==="
          
          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          SEMGREP_ERROR=${{ steps.semgrep.outputs.error_findings || '0' }}
          NPM_CRITICAL=${{ steps.npm-audit.outputs.critical_vulnerabilities || '0' }}
          NPM_HIGH=${{ steps.npm-audit.outputs.high_vulnerabilities || '0' }}
          BANDIT_HIGH=${{ steps.bandit.outputs.high_findings || '0' }}
          
          # –ü–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å)
          FAIL=false
          REASONS=""
          
          # –ü—Ä–∞–≤–∏–ª–æ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ npm –±–ª–æ–∫–∏—Ä—É—é—Ç
          if [ "$NPM_CRITICAL" -gt 0 ]; then
            FAIL=true
            REASONS="$REASONS Found $NPM_CRITICAL CRITICAL npm vulnerabilities; "
          fi
          
          # –ü—Ä–∞–≤–∏–ª–æ 2: High —É—è–∑–≤–∏–º–æ—Å—Ç–∏ npm –±–ª–æ–∫–∏—Ä—É—é—Ç
          if [ "$NPM_HIGH" -gt 2 ]; then  # –î–æ–ø—É—Å–∫–∞–µ–º –¥–æ 2 high
            FAIL=true
            REASONS="$REASONS Found $NPM_HIGH HIGH npm vulnerabilities (limit: 2); "
          fi
          
          # –ü—Ä–∞–≤–∏–ª–æ 3: High Bandit findings –±–ª–æ–∫–∏—Ä—É—é—Ç
          if [ "$BANDIT_HIGH" -gt 0 ]; then
            FAIL=true
            REASONS="$REASONS Found $BANDIT_HIGH HIGH Bandit issues; "
          fi
          
          # –ü—Ä–∞–≤–∏–ª–æ 4: Semgrep ERROR –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–∫ warning
          if [ "$SEMGREP_ERROR" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $SEMGREP_ERROR Semgrep ERROR findings (review recommended)"
            # –ú–æ–∂–Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å
            # FAIL=true
            # REASONS="$REASONS Found $SEMGREP_ERROR Semgrep ERROR findings; "
          fi
          
          if [ "$FAIL" = true ]; then
            echo "all-passed=false" >> $GITHUB_OUTPUT
            echo "::error::Security gate blocked: $REASONS"
            echo "‚ùå Security checks failed: $REASONS"
            exit 1
          else
            echo "all-passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All security checks passed"
          fi

      - name: Create GitHub annotations (optional)
        if: failure() && github.event_name == 'pull_request'
        run: |
          # –°–æ–∑–¥–∞–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
          if [ -f "semgrep-results.json" ]; then
            jq -r '.results[] | select(.extra.severity == "ERROR") | "::error file=\(.path),line=\(.start.line),col=\(.start.col)::[Semgrep] \(.extra.message)"' semgrep-results.json || true
          fi
