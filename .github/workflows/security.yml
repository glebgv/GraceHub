name: Security Scan
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    outputs:
      all-passed: ${{ steps.check-all.outputs.all-passed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - Show repository structure
        run: |
          echo "=== Repository structure ==="
          find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" -o -name "*.java" -o -name "*.go" \) | head -20 || true
          echo "=== Files in root ==="
          ls -la

      - name: Semgrep scan
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: auto
        env:
          SEMGREP_VERBOSE: "true"  # Включаем подробное логирование
          SEMGREP_TIMEOUT: "300"   # Увеличиваем таймаут до 5 минут

      - name: Debug - Check Semgrep outcome
        if: always()
        run: |
          echo "=== Semgrep Status ==="
          echo "Step outcome: ${{ steps.semgrep.outcome }}"
          echo "Step conclusion: ${{ steps.semgrep.conclusion }}"
          
          # Проверяем outputs от Semgrep
          echo "=== Semgrep Outputs ==="
          echo "Has findings? ${{ steps.semgrep.outputs.has-findings }}"
          echo "Findings count: ${{ steps.semgrep.outputs.findings-count }}"
          echo "Exit code: ${{ steps.semgrep.outputs.exit-code }}"

      - name: Check if frontend-miniapp exists
        id: check-miniapp
        run: |
          if [ -d "./frontend-miniapp" ]; then
            echo "✅ frontend-miniapp directory exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ frontend-miniapp directory not found"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: npm audit (miniapp)
        id: npm-audit-miniapp
        if: steps.check-miniapp.outputs.exists == 'true'
        working-directory: ./frontend-miniapp
        continue-on-error: true
        run: |
          echo "=== npm audit in frontend-miniapp ==="
          echo "Directory: $(pwd)"
          
          # Проверяем package.json
          if [ ! -f "package.json" ]; then
            echo "❌ package.json not found"
            echo "npm_exit_code=1" >> $GITHUB_OUTPUT
            exit 0  # Продолжаем workflow
          fi
          
          # Запускаем npm audit
          echo "Running npm audit..."
          AUDIT_OUTPUT=$(npm audit --audit-level=high --omit=dev --json 2>&1) || true
          
          # Сохраняем результат
          echo "$AUDIT_OUTPUT" > npm-audit-results.json
          
          # Анализируем результат
          if echo "$AUDIT_OUTPUT" | grep -q '"error":'; then
            echo "⚠️ npm audit encountered an error"
            echo "npm_exit_code=1" >> $GITHUB_OUTPUT
          elif echo "$AUDIT_OUTPUT" | jq -e '.metadata.vulnerabilities.high > 0 or .metadata.vulnerabilities.critical > 0' >/dev/null 2>&1; then
            echo "❌ npm audit found high/critical vulnerabilities"
            echo "Vulnerabilities:"
            echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities'
            echo "npm_exit_code=1" >> $GITHUB_OUTPUT
          else
            echo "✅ npm audit passed"
            echo "npm_exit_code=0" >> $GITHUB_OUTPUT
          fi

      - name: Bandit
        id: bandit
        uses: PyCQA/bandit-action@v1
        continue-on-error: true
        with:
          # Используем правильные параметры для bandit-action
          targets: .  # Сканируем текущую директорию
          severity: low  # Начинаем с low severity
          confidence: low
          exclude: .git,node_modules,venv,__pycache__

      - name: Debug - Check Bandit status
        if: always()
        run: |
          echo "=== Bandit Status ==="
          echo "Step outcome: ${{ steps.bandit.outcome }}"
          echo "Step conclusion: ${{ steps.bandit.conclusion }}"

      - name: Check all scans passed
        id: check-all
        run: |
          echo "=== Final Security Check ==="
          
          # Получаем статусы всех шагов
          SEMGREP_OK=${{ steps.semgrep.outcome == 'success' }}
          MINIAPP_EXISTS=${{ steps.check-miniapp.outputs.exists == 'true' }}
          
          if [ "$MINIAPP_EXISTS" = "true" ]; then
            NPM_OK=${{ steps.npm-audit-miniapp.outcome == 'success' }}
            NPM_EXIT_CODE=${{ steps.npm-audit-miniapp.outputs.npm_exit_code || '0' }}
          else
            NPM_OK=true
            NPM_EXIT_CODE=0
          fi
          
          BANDIT_OK=${{ steps.bandit.outcome == 'success' }}
          
          echo "Semgrep OK: $SEMGREP_OK"
          echo "MiniApp exists: $MINIAPP_EXISTS"
          echo "npm audit OK: $NPM_OK (exit code: $NPM_EXIT_CODE)"
          echo "Bandit OK: $BANDIT_OK"
          
          # Проверяем общий статус
          ALL_OK=true
          FAILED_SCANS=""
          
          if [ "$SEMGREP_OK" != "true" ]; then
            ALL_OK=false
            FAILED_SCANS="$FAILED_SCANS Semgrep"
          fi
          
          if [ "$MINIAPP_EXISTS" = "true" ] && [ "$NPM_OK" != "true" ]; then
            ALL_OK=false
            FAILED_SCANS="$FAILED_SCANS npm-audit"
          fi
          
          if [ "$BANDIT_OK" != "true" ]; then
            ALL_OK=false
            FAILED_SCANS="$FAILED_SCANS Bandit"
          fi
          
          if [ "$ALL_OK" = "true" ]; then
            echo "all-passed=true" >> $GITHUB_OUTPUT
            echo "✅ All security scans passed"
          else
            echo "all-passed=false" >> $GITHUB_OUTPUT
            echo "❌ Failed security scans: $FAILED_SCANS"
            echo ""
            echo "=== Troubleshooting ==="
            echo "1. Check Semgrep logs above for errors"
            echo "2. If npm audit failed, check ./frontend-miniapp/package.json"
            echo "3. Review Bandit findings if any"
            echo "4. Note: Some tools may fail if they find vulnerabilities (expected behavior)"
            exit 1
          fi

      - name: Upload Semgrep results (optional)
        if: always() && steps.semgrep.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            **/.semgrep.log
            **/semgrep-*.json
          retention-days: 7

      - name: Upload npm audit results (optional)
        if: always() && steps.npm-audit-miniapp.outcome != 'success' && steps.check-miniapp.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: ./frontend-miniapp/npm-audit-results.json
          retention-days: 7
          # gg
