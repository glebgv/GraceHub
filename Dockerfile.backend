FROM mirror.gcr.io/library/python:3.12-slim

# PostgreSQL deps
RUN apt-get update && apt-get install -y \
    libpq-dev gcc g++ curl && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app/src

# Dependencies
COPY requirements.txt ../
RUN pip install --no-cache-dir -r ../requirements.txt

# Source code (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ queue_worker.py Ð² src/)
COPY src/ ./

# ENV
ENV PYTHONPATH=/app/src
ENV APP_BASE_DIR=/app
ENV PYTHONUNBUFFERED=1

# === TARGETS ===
FROM mirror.gcr.io/library/python:3.12-slim AS queue-worker
RUN apt-get update && apt-get install -y libpq-dev gcc g++ curl && rm -rf /var/lib/apt/lists/*
WORKDIR /app/src
COPY requirements.txt ../
RUN pip install --no-cache-dir -r ../requirements.txt
COPY src/ ./
ENV PYTHONPATH=/app/src
ENV APP_BASE_DIR=/app
ENV PYTHONUNBUFFERED=1
CMD ["python", "queue_worker.py"]

FROM mirror.gcr.io/library/python:3.12-slim AS api
RUN apt-get update && apt-get install -y libpq-dev gcc g++ curl && rm -rf /var/lib/apt/lists/*
WORKDIR /app/src
COPY requirements.txt ../
RUN pip install --no-cache-dir -r ../requirements.txt
COPY src/ ./
ENV PYTHONPATH=/app/src
ENV APP_BASE_DIR=/app
ENV PYTHONUNBUFFERED=1
EXPOSE 8001
CMD ["bash", "-c", "python -u -m master_bot.api_server"]

FROM mirror.gcr.io/library/python:3.12-slim AS master-bot
RUN apt-get update && apt-get install -y libpq-dev gcc g++ curl && rm -rf /var/lib/apt/lists/*
WORKDIR /app/src
COPY requirements.txt ../
RUN pip install --no-cache-dir -r ../requirements.txt
COPY src/ ./

ENV PYTHONPATH=/app/src
ENV APP_BASE_DIR=/app
ENV PYTHONUNBUFFERED=1

EXPOSE 9443

# CMD Ñ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸ÐµÐ¼ PostgreSQL Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· tee
CMD ["bash", "-c", "mkdir -p /app/logs && echo 'â³ master-bot: Waiting 30s for PostgreSQL...' && sleep 30 && echo 'âœ… PostgreSQL ready! Starting MasterBot' && python -u -m master_bot.main 2>&1 | tee /app/logs/masterbot.log"]

FROM mirror.gcr.io/library/python:3.12-slim AS user-worker
RUN apt-get update && apt-get install -y libpq-dev gcc g++ curl && rm -rf /var/lib/apt/lists/*
WORKDIR /app/src
COPY requirements.txt ../
RUN pip install --no-cache-dir -r ../requirements.txt
COPY src/ ./
ENV PYTHONPATH=/app/src
ENV APP_BASE_DIR=/app
ENV PYTHONUNBUFFERED=1
# ðŸ”¥ Ð¤Ð˜ÐšÐ¡: bash -c + PYTHONUNBUFFERED
CMD ["bash", "-c", "python -u -m worker.main"]
